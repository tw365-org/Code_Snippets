<?php
/**
 * Plugin Name: My-Risky-Plugins-Scanner
 * Description: æƒæä¸¦åˆ—å‡ºã€Œé•·æœŸæœªæ›´æ–°(ç´…ç‡ˆ)ã€èˆ‡ã€Œæœªæ¸¬è©¦åˆè¦(é»ƒç‡ˆ)ã€çš„é¢¨éšªå¤–æ›ã€‚
 * Version: 1.1.0 (Feature/Yellow Light Warning)
 * Author: WP Architect Team
 * Date: 2024-12-27
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly
}

class My_Risky_Plugins_Scanner {

    private const TRANSIENT_KEY = 'my_risky_plugins_data_v1_1'; // æ›´æ–° Key ä»¥é¿å…èˆŠå¿«å–å¹²æ“¾
    private const CACHE_TIME    = 86400; // 24 Hours
    private const ITEMS_PER_PAGE = 5;

    public function __construct() {
        add_action( 'wp_dashboard_setup', [ $this, 'add_dashboard_widget' ] );
        add_action( 'wp_ajax_my_scan_plugins', [ $this, 'handle_scan_ajax' ] );
        add_action( 'wp_ajax_my_paginate_risk', [ $this, 'handle_pagination_ajax' ] );
    }

    public function add_dashboard_widget() {
        if ( current_user_can( 'manage_options' ) ) {
            wp_add_dashboard_widget(
                'my_risky_plugins_widget',
                '<span>ğŸ›¡ï¸ My å¤–æ›ç›¸å®¹æ€§èˆ‡é¢¨éšªæª¢æ¸¬</span>',
                [ $this, 'render_widget' ]
            );
        }
    }

    public function render_widget() {
        $risky_plugins = get_transient( self::TRANSIENT_KEY );
        
        echo '<div id="my-risk-wrapper">';
        if ( false === $risky_plugins ) {
            $this->render_scan_button();
        } else {
            $this->render_results( $risky_plugins, 1 );
        }
        echo '</div>';
        $this->render_inline_script();
    }

    public function handle_scan_ajax() {
        check_ajax_referer( 'my_risk_nonce', 'nonce' );
        if ( ! current_user_can( 'manage_options' ) ) wp_send_json_error( 'æ¬Šé™ä¸è¶³' );

        $results = $this->perform_scan();
        set_transient( self::TRANSIENT_KEY, $results, self::CACHE_TIME );

        ob_start();
        $this->render_results( $results, 1 );
        $html = ob_get_clean();

        wp_send_json_success( [ 'html' => $html ] );
    }

    public function handle_pagination_ajax() {
        check_ajax_referer( 'my_risk_nonce', 'nonce' );
        $page = isset( $_POST['page'] ) ? absint( $_POST['page'] ) : 1;
        $risky_plugins = get_transient( self::TRANSIENT_KEY );

        if ( false === $risky_plugins ) wp_send_json_error( 'å¿«å–å·²éæœŸï¼Œè«‹é‡æ–°æƒæ' );

        ob_start();
        $this->render_results( $risky_plugins, $page );
        $html = ob_get_clean();

        wp_send_json_success( [ 'html' => $html ] );
    }

    /**
     * æ ¸å¿ƒé‚è¼¯ï¼šåŸ·è¡Œå¤–æ›æ¯”å°æƒæ (å«ç´…/é»ƒç‡ˆåˆ¤å®š)
     */
    private function perform_scan() {
        if ( ! function_exists( 'get_plugins' ) ) require_once ABSPATH . 'wp-admin/includes/plugin.php';
        include_once( ABSPATH . 'wp-admin/includes/plugin-install.php' ); 

        $all_plugins = get_plugins();
        $risky_list  = [];
        
        global $wp_version;
        // ç§»é™¤ç‰ˆæœ¬è™Ÿä¸­çš„å°¾ç¢¼ (ä¾‹å¦‚ 6.4.2-alpha -> 6.4.2) ç¢ºä¿æ¯”è¼ƒæ­£ç¢º
        $clean_wp_version = explode( '-', $wp_version )[0];
        $current_major    = $this->get_major_version( $clean_wp_version );

        foreach ( $all_plugins as $plugin_path => $data ) {
            $slug = dirname( $plugin_path );
            if ( '.' === $slug || empty( $slug ) ) $slug = basename( $plugin_path, '.php' );

            $api_data = plugins_api( 'plugin_information', [
                'slug'   => $slug,
                'fields' => [ 'tested' => true ]
            ]);

            if ( is_wp_error( $api_data ) ) continue;

            $tested_version = $api_data->tested;
            $tested_major   = $this->get_major_version( $tested_version );

            // è¨ˆç®—é‚è¼¯
            $gap = (int)( $current_major * 10 ) - (int)( $tested_major * 10 );
            $is_tested_less_than_current = version_compare( $tested_version, $clean_wp_version, '<' );

            $status = '';
            $reason = '';

            // åˆ¤å®šé †åºï¼šå…ˆåˆ¤æ–·ç´…ç‡ˆ (æœ€åš´é‡)ï¼Œå†åˆ¤æ–·é»ƒç‡ˆ
            if ( $gap >= 3 ) {
                // ç´…ç‡ˆæ¢ä»¶ï¼šè½å¾Œ 3 å€‹ä¸»è¦ç‰ˆæœ¬
                $status = 'high'; // Red
                $reason = 'âš ï¸ åš´é‡éæœŸï¼šåƒ…æ¸¬è©¦è‡³ WP ' . $tested_version;
            } elseif ( $is_tested_less_than_current ) {
                // é»ƒç‡ˆæ¢ä»¶ï¼šæœªé”ç´…ç‡ˆï¼Œä½† Tested < Current
                $status = 'medium'; // Yellow
                $reason = 'âœ‹ ç›¸å®¹æ€§è­¦å‘Šï¼šå°šæœªèˆ‡æ‚¨çš„ WP ç‰ˆæœ¬ (' . $clean_wp_version . ') æ¸¬è©¦ (ç›®å‰: ' . $tested_version . ')';
            }

            if ( ! empty( $status ) ) {
                $risky_list[] = [
                    'name'    => $data['Name'],
                    'slug'    => $slug,
                    'version' => $data['Version'],
                    'tested'  => $tested_version,
                    'status'  => $status, // 'high' or 'medium'
                    'reason'  => $reason
                ];
            }
        }

        // æ’åºï¼šHigh (Red) å„ªå…ˆï¼ŒMedium (Yellow) æ¬¡ä¹‹
        usort( $risky_list, function( $a, $b ) {
            if ( $a['status'] === $b['status'] ) return 0;
            return ( $a['status'] === 'high' ) ? -1 : 1;
        });

        return $risky_list;
    }

    private function get_major_version( $version ) {
        $parts = explode( '.', $version );
        if ( count( $parts ) >= 2 ) {
            return (float)( $parts[0] . '.' . $parts[1] );
        }
        return (float) $version;
    }

    private function render_scan_button() {
        ?>
        <div style="text-align: center; padding: 20px;">
            <p>å°šæœªæœ‰æª¢æ¸¬è³‡æ–™ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æƒæã€‚</p>
            <button id="my-start-scan" class="button button-primary">ğŸš€ é–‹å§‹é¢¨éšªæƒæ</button>
            <span class="spinner" style="float:none;"></span>
        </div>
        <?php
    }

    private function render_results( $data, $page ) {
        $total_count = count( $data );
        
        // çµ±è¨ˆå„é¡é¢¨éšªæ•¸é‡
        $high_count = 0;
        $medium_count = 0;
        foreach ( $data as $item ) {
            if ( $item['status'] === 'high' ) $high_count++;
            else $medium_count++;
        }

        // æ±ºå®š Banner é¡è‰²èˆ‡æ–‡å­—
        if ( $high_count > 0 ) {
            $bg_color    = '#d63638'; // Red
            $icon        = 'dashicons-warning';
            $status_text = "ç™¼ç¾ {$high_count} å€‹é«˜é¢¨éšªå¤–æ›" . ( $medium_count > 0 ? "ï¼Œ{$medium_count} å€‹è­¦å‘Š" : "" );
        } elseif ( $medium_count > 0 ) {
            $bg_color    = '#f0b849'; // Yellow/Amber
            $icon        = 'dashicons-flag';
            $status_text = "ç™¼ç¾ {$medium_count} å€‹ç›¸å®¹æ€§è­¦å‘Š (å°šæœªæ¸¬è©¦)";
        } else {
            $bg_color    = '#00a32a'; // Green
            $icon        = 'dashicons-yes-alt';
            $status_text = "ç³»çµ±å¥åº·ï¼šç„¡ç›¸å®¹æ€§é¢¨éšª";
        }

        // è¼¸å‡º Banner
        // æ³¨æ„ï¼šå¦‚æœæ˜¯é»ƒè‰²èƒŒæ™¯ï¼Œæ–‡å­—é¡è‰²å»ºè­°ç”¨æ·±è‰²ä»¥åˆ©é–±è®€ï¼Œæˆ–æ˜¯æ·±é»ƒè‰²é…ç™½å­—ã€‚é€™è£¡ä½¿ç”¨ WP åŸç”Ÿ Warning é¢¨æ ¼ (Amber border left) æˆ–ç´”è‰²å¡Š
        // ç‚ºæ±‚çµ±ä¸€ç¾è§€ï¼Œé€™è£¡ä½¿ç”¨æ·±é»ƒè‰²èƒŒæ™¯é…ç™½å­—
        $text_color = '#fff';
        if ( $medium_count > 0 && $high_count === 0 ) {
             $bg_color = '#dba617'; // Darker yellow for better white text contrast
        }

        echo '<div style="background: ' . esc_attr( $bg_color ) . '; color: ' . esc_attr($text_color) . '; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: flex; align-items: center;">';
        echo '<span class="dashicons ' . esc_attr( $icon ) . '" style="margin-right: 8px; font-size: 24px; width: 24px; height: 24px;"></span>';
        echo '<strong>' . esc_html( $status_text ) . '</strong>';
        echo '</div>';

        if ( $total_count === 0 ) return;

        // åˆ†é èˆ‡åˆ—è¡¨æ¸²æŸ“
        $total_pages = ceil( $total_count / self::ITEMS_PER_PAGE );
        $page = max( 1, min( $page, $total_pages ) );
        $offset = ( $page - 1 ) * self::ITEMS_PER_PAGE;
        $paged_data = array_slice( $data, $offset, self::ITEMS_PER_PAGE );

        echo '<ul style="margin: 0; padding: 0; list-style: none;">';
        foreach ( $paged_data as $plugin ) {
            $wp_org_url = 'https://tw.wordpress.org/plugins/' . esc_attr( $plugin['slug'] ) . '/';
            
            // æ ¹æ“šå€‹åˆ¥é …ç›®æ±ºå®šé¡è‰²
            $text_color = ( $plugin['status'] === 'high' ) ? '#d63638' : '#dba617';
            $icon_char  = ( $plugin['status'] === 'high' ) ? 'âš ï¸' : 'âœ‹'; // è­¦å‘Šæ‰‹å‹¢ æˆ– é©šå˜†è™Ÿ

            echo '<li style="border-bottom: 1px solid #eee; padding: 8px 0;">';
            echo '<div style="font-weight: 600; font-size: 14px; margin-bottom:2px;">' . esc_html( $plugin['name'] ) . '</div>';
            
            // é¡¯ç¤ºåŸå› 
            echo '<div style="color: ' . esc_attr( $text_color ) . '; font-size: 12px; margin-bottom: 4px;">';
            echo esc_html( $plugin['reason'] );
            echo '</div>';
            
            echo '<div>';
            echo '<a href="' . esc_url( $wp_org_url ) . '" target="_blank" class="button button-small">æŸ¥çœ‹é é¢ <span class="dashicons dashicons-external" style="line-height: 24px; font-size: 14px;"></span></a>';
            echo '</div>';
            echo '</li>';
        }
        echo '</ul>';

        if ( $total_pages > 1 ) {
            echo '<div class="my-pagination" style="display: flex; justify-content: center; gap: 5px; margin-top: 15px; align-items: center;">';
            echo '<button class="button my-pg-btn" data-page="1" ' . disabled( $page, 1, false ) . '>Â«</button>';
            echo '<button class="button my-pg-btn" data-page="' . ( $page - 1 ) . '" ' . disabled( $page, 1, false ) . '>â€¹</button>';
            echo '<span style="font-size: 12px; line-height: 28px; margin: 0 5px;">é æ¬¡ ' . esc_html( $page ) . ' / ' . esc_html( $total_pages ) . '</span>';
            echo '<button class="button my-pg-btn" data-page="' . ( $page + 1 ) . '" ' . disabled( $page, $total_pages, false ) . '>â€º</button>';
            echo '<button class="button my-pg-btn" data-page="' . esc_attr( $total_pages ) . '" ' . disabled( $page, $total_pages, false ) . '>Â»</button>';
            echo '</div>';
        }
        
        echo '<div style="text-align: right; margin-top: 10px;">';
        echo '<button id="my-rescan" class="button-link" style="color: #666; font-size: 11px;">ğŸ”„ é‡æ–°æƒæ (æ¸…é™¤å¿«å–)</button>';
        echo '</div>';
    }

    private function render_inline_script() {
        $nonce = wp_create_nonce( 'my_risk_nonce' );
        ?>
        <script type="text/javascript">
        jQuery(document).ready(function($) {
            var wrapper = $('#my-risk-wrapper');
            var nonce = '<?php echo esc_js( $nonce ); ?>';
            
            // ç¶å®šäº‹ä»¶ (èˆ‡ä¹‹å‰ç›¸åŒï¼Œç•¥å¾®å„ªåŒ– Loading é«”é©—)
            $(document).on('click', '#my-start-scan, #my-rescan', function(e) {
                e.preventDefault();
                wrapper.html('<div style="text-align:center; padding:20px;"><span class="spinner is-active" style="float:none; margin:0 auto 10px;"></span><p>æ­£åœ¨åˆ†æå¤–æ›ç›¸å®¹æ€§...</p><p style="font-size:12px;color:#666;">å¯èƒ½éœ€è¦é€£æ¥ WordPress.org è³‡æ–™åº«</p></div>');
                $.post(ajaxurl, { action: 'my_scan_plugins', nonce: nonce }, function(res) {
                    wrapper.html(res.success ? res.data.html : '<div class="notice notice-error inline"><p>'+res.data+'</p></div>');
                });
            });

            $(document).on('click', '.my-pg-btn', function(e) {
                e.preventDefault();
                var page = $(this).data('page');
                $('.my-pagination .button').addClass('disabled');
                wrapper.css('opacity', '0.5');
                $.post(ajaxurl, { action: 'my_paginate_risk', nonce: nonce, page: page }, function(res) {
                    wrapper.css('opacity', '1');
                    wrapper.html(res.success ? res.data.html : '<div class="notice notice-error inline"><p>'+res.data+'</p></div>');
                });
            });
        });
        </script>
        <?php
    }
}

new My_Risky_Plugins_Scanner();
